---
import BaseLayout from "./BaseLayout.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import TableOfContents from "../components/TableOfContents.astro";
import RelatedArticles from "../components/RelatedArticles.astro";
import AffiliateDisclosure from "../components/AffiliateDisclosure.astro";
import { articleSchema, softwareAppSchema } from "../utils/schema";

interface Props {
  entry: {
    id: string;
    data: Record<string, any>;
  };
  headings: { depth: number; slug: string; text: string }[];
  section: string;
  sectionLabel: string;
  relatedArticles?: any[];
}

const { entry, headings, section, sectionLabel, relatedArticles = [] } =
  Astro.props;

const jsonLd: object[] = [
  articleSchema({
    title: entry.data.title,
    description: entry.data.description,
    datePublished: entry.data.datePublished,
    dateModified: entry.data.dateUpdated,
    url: Astro.url.href,
  }),
];

if (entry.data.type === "app-guide" && entry.data.officialUrl) {
  jsonLd.push(
    softwareAppSchema({
      name: entry.data.app,
      url: entry.data.officialUrl,
    })
  );
}

const showAffiliate =
  entry.data.type === "hardware" && entry.data.hasAffiliateLinks;
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  jsonLd={jsonLd}
>
  <Breadcrumbs
    items={[
      { label: "Home", href: "/" },
      { label: sectionLabel, href: `/${section}/` },
      { label: entry.data.title },
    ]}
  />

  <article class="mt-6">
    <header class="mb-8">
      <h1
        class="text-3xl sm:text-4xl font-[family-name:var(--font-display)] font-extrabold leading-tight"
      >
        {entry.data.title}
      </h1>
      <div
        class="mt-3 flex flex-wrap items-center gap-4 text-secondary text-sm font-[family-name:var(--font-mono)]"
      >
        <time datetime={entry.data.datePublished.toISOString()}>
          {
            entry.data.datePublished.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          }
        </time>
        {
          entry.data.dateUpdated > entry.data.datePublished && (
            <span>
              Updated:{" "}
              <time datetime={entry.data.dateUpdated.toISOString()}>
                {entry.data.dateUpdated.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </time>
            </span>
          )
        }
        {
          "difficulty" in entry.data && (
            <span
              class:list={[
                "px-2 py-0.5 rounded text-xs uppercase tracking-wider",
                {
                  "bg-green-900/30 text-accent":
                    entry.data.difficulty === "beginner",
                  "bg-yellow-900/30 text-yellow-400":
                    entry.data.difficulty === "intermediate",
                  "bg-red-900/30 text-red-400":
                    entry.data.difficulty === "advanced",
                },
              ]}
            >
              {entry.data.difficulty}
            </span>
          )
        }
      </div>
    </header>

    {showAffiliate && <AffiliateDisclosure />}

    {headings.length > 2 && <TableOfContents headings={headings} />}

    <div
      class="prose prose-invert prose-lg max-w-none
             prose-headings:font-[family-name:var(--font-display)]
             prose-a:text-accent prose-a:no-underline hover:prose-a:underline
             prose-code:text-accent prose-code:bg-surface prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded
             prose-th:border-border prose-td:border-border
             prose-img:rounded-lg"
    >
      <slot />
    </div>
  </article>

  {
    relatedArticles.length > 0 && (
      <RelatedArticles articles={relatedArticles} currentId={entry.id} />
    )
  }
</BaseLayout>
