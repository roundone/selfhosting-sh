---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const allApps = await getCollection('apps', ({ data }) => !data.draft);
const allCompare = await getCollection('compare', ({ data }) => !data.draft);
const allBest = await getCollection('best', ({ data }) => !data.draft);
const allReplace = await getCollection('replace', ({ data }) => !data.draft);
const allFoundations = await getCollection('foundations', ({ data }) => !data.draft);
const allHardware = await getCollection('hardware', ({ data }) => !data.draft);

const totalArticles = allApps.length + allCompare.length + allBest.length + allReplace.length + allFoundations.length + allHardware.length;

const categories = [
  { name: 'App Guides', href: '/apps/', description: 'Setup tutorials for self-hosted apps', count: allApps.length },
  { name: 'Comparisons', href: '/compare/', description: 'Head-to-head app comparisons', count: allCompare.length },
  { name: 'Best Of', href: '/best/', description: 'Top picks by category', count: allBest.length },
  { name: 'Replace', href: '/replace/', description: 'Drop your cloud subscriptions', count: allReplace.length },
  { name: 'Hardware', href: '/hardware/', description: 'Servers, NAS, drives, and builds', count: allHardware.length },
  { name: 'Foundations', href: '/foundations/', description: 'Docker, networking, Linux basics', count: allFoundations.length },
];

// Recent articles across all collections
const allArticles = [
  ...allApps.map(a => ({ ...a, collection: 'apps' })),
  ...allCompare.map(a => ({ ...a, collection: 'compare' })),
  ...allBest.map(a => ({ ...a, collection: 'best' })),
  ...allReplace.map(a => ({ ...a, collection: 'replace' })),
  ...allHardware.map(a => ({ ...a, collection: 'hardware' })),
  ...allFoundations.map(a => ({ ...a, collection: 'foundations' })),
].sort((a, b) => b.data.date.getTime() - a.data.date.getTime()).slice(0, 12);

const websiteLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'selfhosting.sh',
  url: 'https://selfhosting.sh',
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: 'https://selfhosting.sh/search/?q={search_term_string}',
    },
    'query-input': 'required name=search_term_string',
  },
};
---
<Base title="selfhosting.sh" description="Replace your cloud subscriptions with stuff you run yourself. Self-hosting guides, comparisons, and setup tutorials." jsonLd={websiteLd}>
  <div class="hero">
    <h1><span class="highlight">$</span> Replace your cloud subscriptions</h1>
    <p>Practical guides to self-hosting everything. Docker setup tutorials, app comparisons, and hardware recommendations â€” no fluff.</p>
    <p style="font-size: var(--font-size-sm); color: var(--text-muted); margin-top: 0.5rem;">{totalArticles} guides and growing</p>
    <div id="search"></div>
  </div>

  <section>
    <h2 style="margin-bottom: 1rem;">Browse by category</h2>
    <div class="categories-grid">
      {categories.map(({ name, href, description, count }) => (
        <a href={href} class="category-card">
          <h3>{name}</h3>
          <p>{description}</p>
          {count > 0 && <p style="margin-top: 0.25rem; color: var(--accent); font-size: var(--font-size-xs);">{count} guides</p>}
        </a>
      ))}
    </div>
  </section>

  {allArticles.length > 0 && (
    <section style="margin-top: 3rem;">
      <h2 style="margin-bottom: 1rem;">Latest guides</h2>
      <div class="article-grid">
        {allArticles.map((article) => (
          <a href={`/${article.collection}/${article.id}/`} class="article-card">
            <h2>{article.data.title}</h2>
            <p>{article.data.description}</p>
            <div class="article-card-meta">
              <span class="article-category">{article.data.category}</span>
              {' '}&middot;{' '}
              <time datetime={article.data.date.toISOString()}>
                {article.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
              </time>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  <script is:inline>
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof PagefindUI !== 'undefined') {
        new PagefindUI({
          element: '#search',
          showSubResults: true,
          showImages: false,
        });
      }
    });
  </script>
</Base>
