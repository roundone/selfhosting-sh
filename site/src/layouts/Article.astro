---
import Base from './Base.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import AffiliateDisclosure from '../components/AffiliateDisclosure.astro';
import RelatedArticles from '../components/RelatedArticles.astro';

interface Props {
  title: string;
  description: string;
  date: Date;
  dateUpdated?: Date;
  category: string;
  apps?: string[];
  tags?: string[];
  author?: string;
  image?: string;
  imageAlt?: string;
  affiliateDisclosure?: boolean;
  draft?: boolean;
  headings?: { depth: number; slug: string; text: string }[];
  collectionName: string;
  slug: string;
  rawBody?: string;
}

const {
  title,
  description,
  date,
  dateUpdated,
  category,
  apps = [],
  tags = [],
  author = 'selfhosting.sh',
  image,
  imageAlt,
  affiliateDisclosure = false,
  headings = [],
  collectionName,
  slug,
  rawBody = '',
} = Astro.props;

const categoryLabels: Record<string, string> = {
  apps: 'App Guides',
  compare: 'Comparisons',
  best: 'Best Of',
  replace: 'Replace',
  hardware: 'Hardware',
  foundations: 'Foundations',
  troubleshooting: 'Troubleshooting',
};

const categoryLabel = categoryLabels[collectionName] || collectionName;
const categoryPath = `/${collectionName}/`;

const formatDate = (d: Date) => d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

const crumbs = [
  { label: 'Home', href: '/' },
  { label: categoryLabel, href: categoryPath },
  { label: title },
];

const canonicalUrl = new URL(`${categoryPath}${slug}/`, Astro.site).href;
const ogImageUrl = image || new URL(`/og/${collectionName}/${slug}.png`, Astro.site).href;

// Article JSON-LD
const articleLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  datePublished: date.toISOString(),
  author: {
    '@type': 'Organization',
    name: author,
    url: Astro.site?.href,
  },
  publisher: {
    '@type': 'Organization',
    name: 'selfhosting.sh',
    url: Astro.site?.href,
  },
};
if (dateUpdated) articleLd.dateModified = dateUpdated.toISOString();
articleLd.image = ogImageUrl;

// SoftwareApplication schema for app guides
const jsonLdArray: object[] = [articleLd];
if (collectionName === 'apps' && apps.length > 0) {
  jsonLdArray.push({
    '@context': 'https://schema.org',
    '@type': 'SoftwareApplication',
    name: apps[0],
    operatingSystem: 'Linux, Docker',
    applicationCategory: 'Self-Hosted Software',
    offers: {
      '@type': 'Offer',
      price: '0',
      priceCurrency: 'USD',
    },
  });
}

// ItemList schema for roundup ("best") articles
if (collectionName === 'best' && apps.length > 0) {
  jsonLdArray.push({
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: title,
    numberOfItems: apps.length,
    itemListElement: apps.map((app, i) => ({
      '@type': 'ListItem',
      position: i + 1,
      name: app,
    })),
  });
}

// HowTo schema for foundation/tutorial articles
if (collectionName === 'foundations') {
  const steps = headings
    .filter((h) => h.depth === 2)
    .map((h) => ({
      '@type': 'HowToStep',
      name: h.text,
      url: `${canonicalUrl}#${h.slug}`,
    }));
  if (steps.length >= 2) {
    jsonLdArray.push({
      '@context': 'https://schema.org',
      '@type': 'HowTo',
      name: title,
      description,
      step: steps,
    });
  }
}

// FAQPage schema auto-detection
// Detects FAQ sections (## FAQ or ## Frequently Asked Questions) with ### questions and answer paragraphs
if (rawBody) {
  const sections = rawBody.split(/^## /m);
  let faqSectionContent = '';
  for (const section of sections) {
    const firstLine = section.split('\n')[0]?.trim() || '';
    if (firstLine === 'FAQ' || firstLine === 'Frequently Asked Questions') {
      faqSectionContent = section.substring(firstLine.length).trim();
      break;
    }
  }
  if (faqSectionContent) {
    const questionBlocks = faqSectionContent.split(/^### /m).filter(Boolean);
    const faqItems: { question: string; answer: string }[] = [];
    for (const block of questionBlocks) {
      const lines = block.trim().split('\n');
      const question = lines[0]?.trim();
      if (!question) continue;
      const answerLines = lines.slice(1).filter((l) => l.trim() !== '');
      const answer = answerLines.map((l) => l.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1').trim()).join(' ').trim();
      if (answer) {
        faqItems.push({ question, answer });
      }
    }
    if (faqItems.length >= 2) {
      jsonLdArray.push({
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: faqItems.map((item) => ({
          '@type': 'Question',
          name: item.question,
          acceptedAnswer: {
            '@type': 'Answer',
            text: item.answer,
          },
        })),
      });
    }
  }
}

const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---
<Base
  title={title}
  description={description}
  ogImage={ogImageUrl}
  ogType="article"
  canonicalUrl={canonicalUrl}
  jsonLd={jsonLdArray}
>
  <Breadcrumbs crumbs={crumbs} />

  {affiliateDisclosure && <AffiliateDisclosure />}

  <div class="article-layout">
    <article class="article" data-pagefind-body>
      <header class="article-header">
        <h1>{title}</h1>
        <div class="article-meta">
          <span class="article-category">{category}</span>
          <time datetime={date.toISOString()}>{formatDate(date)}</time>
          {dateUpdated && (
            <span>Updated: <time datetime={dateUpdated.toISOString()}>{formatDate(dateUpdated)}</time></span>
          )}
        </div>
      </header>

      <div class="prose">
        <slot />
      </div>

      <RelatedArticles
        currentSlug={slug}
        currentCollection={collectionName}
        category={category}
        apps={apps}
        tags={tags}
      />
    </article>

    {tocHeadings.length > 0 && (
      <aside class="toc">
        <div class="toc-title">On this page</div>
        <ul>
          {tocHeadings.map((h) => (
            <li class={h.depth === 3 ? 'toc-h3' : ''}>
              <a href={`#${h.slug}`}>{h.text}</a>
            </li>
          ))}
        </ul>
      </aside>
    )}
  </div>

  {tocHeadings.length > 0 && (
    <script is:inline>
      (function() {
        var headings = document.querySelectorAll('.prose h2[id], .prose h3[id]');
        var tocLinks = document.querySelectorAll('.toc a');
        if (!headings.length || !tocLinks.length) return;
        var observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              tocLinks.forEach(function(l) { l.classList.remove('active'); });
              var link = document.querySelector('.toc a[href="#' + entry.target.id + '"]');
              if (link) link.classList.add('active');
            }
          });
        }, { rootMargin: '-80px 0px -70% 0px' });
        headings.forEach(function(h) { observer.observe(h); });
      })();
    </script>
  )}
</Base>
