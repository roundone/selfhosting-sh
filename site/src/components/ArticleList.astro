---
interface Article {
  id: string;
  data: {
    title: string;
    description: string;
    date: Date;
    category: string;
    draft: boolean;
  };
}

interface Props {
  articles: Article[];
  collectionPath: string;
  groupByCategory?: boolean;
}

const { articles, collectionPath, groupByCategory = false } = Astro.props;

const sorted = articles
  .filter((a) => !a.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const categoryLabels: Record<string, string> = {
  'home-automation': 'Home Automation',
  'docker-management': 'Docker Management',
  'reverse-proxy-ssl': 'Reverse Proxy & SSL',
  'password-management': 'Password Management',
  'ad-blocking-dns': 'Ad Blocking & DNS',
  'note-taking-knowledge': 'Note Taking & Knowledge',
  'file-sync-storage': 'File Sync & Storage',
  'vpn-remote-access': 'VPN & Remote Access',
  'photo-management': 'Photo & Video Management',
  'media-servers': 'Media Servers',
  'monitoring-uptime': 'Monitoring & Uptime',
  'backup': 'Backup',
  'analytics': 'Analytics',
  'download-management': 'Download Management',
  'cms-websites': 'CMS & Websites',
  'ai-ml': 'AI & Machine Learning',
  'game-servers': 'Game Servers',
  'database-management': 'Database Management',
  'authentication-sso': 'Authentication & SSO',
  'project-management': 'Project Management',
  'communication': 'Communication',
  'invoicing-finance': 'Invoicing & Finance',
  'logging': 'Logging',
  'time-tracking': 'Time Tracking',
  'inventory-management': 'Inventory Management',
  'media-organization': 'Media Organization',
  'ticketing-helpdesk': 'Ticketing & Helpdesk',
};
const formatCategory = (cat: string) =>
  categoryLabels[cat] || cat.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());

// Group articles by category
const grouped = new Map<string, typeof sorted>();
if (groupByCategory) {
  for (const article of sorted) {
    const cat = article.data.category;
    if (!grouped.has(cat)) grouped.set(cat, []);
    grouped.get(cat)!.push(article);
  }
}
const sortedCategories = [...grouped.entries()].sort((a, b) => b[1].length - a[1].length);
---
{sorted.length === 0 ? (
  <p style="color: var(--text-secondary);">No guides published yet. Check back soon.</p>
) : groupByCategory && sortedCategories.length > 1 ? (
  <Fragment>
    <div class="category-nav">
      {sortedCategories.map(([cat, items]) => (
        <a href={`#${cat}`} class="category-nav-link">{formatCategory(cat)} ({items.length})</a>
      ))}
    </div>
    {sortedCategories.map(([cat, items]) => (
      <section id={cat} class="category-section">
        <h2 class="category-section-title">{formatCategory(cat)}</h2>
        <div class="article-grid">
          {items.map((article) => (
            <a href={`${collectionPath}${article.id}/`} class="article-card">
              <h2>{article.data.title}</h2>
              <p>{article.data.description}</p>
              <div class="article-card-meta">
                <time datetime={article.data.date.toISOString()}>
                  {article.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                </time>
              </div>
            </a>
          ))}
        </div>
      </section>
    ))}
  </Fragment>
) : (
  <div class="article-grid">
    {sorted.map((article) => (
      <a href={`${collectionPath}${article.id}/`} class="article-card">
        <h2>{article.data.title}</h2>
        <p>{article.data.description}</p>
        <div class="article-card-meta">
          <span class="article-category">{article.data.category}</span>
          {' '}&middot;{' '}
          <time datetime={article.data.date.toISOString()}>
            {article.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
          </time>
        </div>
      </a>
    ))}
  </div>
)}
